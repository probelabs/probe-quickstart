# =============================================================================
# Visor Quickstart Assistant
# =============================================================================
#
# A complete AI assistant in a single file. Customize and run:
#   npx -y @probelabs/visor@latest run assistant.yaml --message "Hello"
#   npx -y @probelabs/visor@latest run assistant.yaml --slack
#
# =============================================================================

version: "1.0"

# =============================================================================
# IMPORTS - Load the assistant workflow engine
# =============================================================================
# This provides all the "magic":
#   - Intent classification (understands what user wants)
#   - Skill activation (picks which tools/knowledge to use)
#   - MCP server wiring (connects to external tools)
#   - Built-in guidelines (output formatting, error handling)
#
# For offline use, download and change to: imports: ["./workflows/assistant.yaml"]
imports:
  - https://raw.githubusercontent.com/probelabs/visor-ee/master/workflows/assistant.yaml

# =============================================================================
# SLACK CONFIG (remove if CLI-only)
# =============================================================================
# Requires SLACK_BOT_TOKEN and SLACK_APP_TOKEN in .env
# See .env.example for setup instructions
slack:
  version: "v1"
  mentions: all      # Respond to @mentions
  threads: required  # Only respond in threads (not channel messages)

# =============================================================================
# MAIN WORKFLOW
# =============================================================================
checks:
  chat:
    type: workflow
    workflow: assistant
    criticality: policy
    assume: ["true"]
    guarantee: "output?.text != null"
    args:
      # =========================================================================
      # QUESTION - The user's message
      # =========================================================================
      # Automatically populated from:
      #   - CLI: --message "your question"
      #   - Slack: the message that mentioned the bot
      # You don't need to change this.
      question: "{{ conversation.current.text }}"

      # =========================================================================
      # SYSTEM PROMPT - Who is your assistant?
      # =========================================================================
      # Keep this SHORT - just identity and domain.
      # Operational guidelines (be helpful, cite sources, etc.) are built-in.
      system_prompt: |
        You are a helpful AI assistant for software development.

      # =========================================================================
      # INTENTS - High-level request categories
      # =========================================================================
      # Help the AI understand the TYPE of request.
      # Skills handle the specifics - intents are just broad categories.
      intents:
        - id: chat
          description: |
            General Q&A, follow-up questions, small talk, or simple requests.
            Includes capabilities questions and summaries.

        - id: code_help
          description: |
            Questions about code, implementation, architecture, or debugging.
            Use when the user needs to understand or explore code.

        - id: task
          description: |
            User wants to create, update, or execute something.
            Includes creating tickets, making code changes, or running tasks.

      # =========================================================================
      # SKILLS - Your assistant's capabilities
      # =========================================================================
      # Each skill bundles:
      #   - description: WHEN to activate (be specific!)
      #   - knowledge: context injected into the prompt
      #   - requires: other skills to auto-activate
      #   - tools: MCP tools to enable (command, workflow, or built-in types)
      #
      # The AI automatically picks relevant skills based on the user's question.
      # =========================================================================
      skills:
        # -----------------------------------------------------------------------
        # CAPABILITIES - What can you do?
        # -----------------------------------------------------------------------
        - id: capabilities
          description: user asks what this assistant can do or about its capabilities
          knowledge: |
            ## What I Can Do
            I'm an AI assistant that can help you with:
            - **Code Exploration**: Search and understand codebases
            - **Engineering**: Make code changes and create PRs
            - **General Q&A**: Answer questions and have conversations
            - **Task Execution**: Run scheduled tasks and reminders

            Just ask me anything!

        # -----------------------------------------------------------------------
        # CODE EXPLORER - Search and understand code
        # -----------------------------------------------------------------------
        # CODE EXPLORER - Search and understand code
        # -----------------------------------------------------------------------
        # Uses the code-talk workflow to provide code exploration capabilities.
        # The workflow: code-talk server connects to the shared code-talk workflow.
        - id: code-explorer
          description: request needs codebase exploration, code search, or implementation details
          knowledge: |
            ## Code Exploration
            You have access to a code exploration tool that can:
            - Search across repositories for code patterns
            - Find function/class definitions
            - Understand how features are implemented
            - Trace data flow between components

            Always provide specific file paths and line numbers in your answers.
          tools:
            code-explorer:
              workflow: code-talk
              inputs:
                # Define which repositories the AI can search
                projects:
                  - name: this-repo
                    path: .
                    description: The current repository
                  # Add more repositories:
                  # - name: backend
                  #   path: /path/to/backend
                  #   description: Backend API server
                  # - name: docs
                  #   repo: myorg/docs        # GitHub repo
                  #   ref: main               # Branch
                  #   description: Documentation

        # -----------------------------------------------------------------------
        # ENGINEER - Make code changes
        # -----------------------------------------------------------------------
        - id: engineer
          description: user wants code changes made, a PR created, or feature implemented
          requires: [code-explorer]  # Auto-activates code-explorer
          knowledge: |
            ## Engineering Tool
            You can make code changes using the engineer tool:
            - Create new files or modify existing ones
            - Run tests and fix issues
            - Create pull requests

            Always explore the codebase first to understand the context,
            then use the engineer tool to make changes.
          tools:
            engineer:
              workflow: engineer
              inputs: {}

        # -----------------------------------------------------------------------
        # SCHEDULER - Reminders and scheduled tasks
        # -----------------------------------------------------------------------
        - id: scheduler
          description: user wants to schedule, list, or cancel reminders or scheduled tasks
          knowledge: |
            ## Scheduler
            You can schedule tasks and reminders:
            - Set one-time reminders: "remind me in 30 minutes"
            - Set recurring tasks: "every Monday at 9am"
            - List and cancel scheduled items
          tools:
            schedule:
              tool: schedule

        # =====================================================================
        # ADD YOUR CUSTOM SKILLS BELOW
        # =====================================================================
        #
        # Example: Jira integration
        # - id: jira
        #   description: user mentions Jira, ticket IDs like PROJ-123, or needs ticket info
        #   knowledge: |
        #     ## Jira Tools
        #     - jira_get_issue: Get ticket details by key
        #     - jira_search: Search with JQL queries
        #     - jira_create_issue: Create new tickets
        #   tools:
        #     jira:
        #       command: uvx
        #       args: ["mcp-atlassian"]
        #       env:
        #         JIRA_URL: "${JIRA_URL}"
        #         JIRA_USERNAME: "${JIRA_USERNAME}"
        #         JIRA_API_TOKEN: "${JIRA_API_TOKEN}"
        #       allowedMethods:
        #         - jira_get_issue
        #         - jira_search
        #         - jira_create_issue
        #
        # Example: Knowledge-only skill (no tools)
        # - id: company-policies
        #   description: questions about company policies, HR, or procedures
        #   knowledge: |
        #     ## Company Policies
        #     - PTO: 20 days per year
        #     - Remote work: Flexible, coordinate with team
        #     - Expenses: Submit within 30 days

# =============================================================================
# TESTS
# =============================================================================
# Run tests: npx -y @probelabs/visor@latest test assistant.yaml
tests:
  defaults:
    strict: true
    ai_provider: mock

  cases:
    - name: basic-chat
      description: Route general chat correctly
      flow:
        - name: chat-flow
          event: manual
          fixture: local.minimal
          routing:
            max_loops: 0
          execution_context:
            conversation:
              transport: cli
              thread: { id: "test-1" }
              messages: [{ role: user, text: "Hello, how are you?", timestamp: "2024-01-01T00:00:00Z" }]
              current: { role: user, text: "Hello, how are you?", timestamp: "2024-01-01T00:00:00Z" }
              attributes: { source: cli }
          mocks:
            chat[]:
              - text: "Hello! I'm doing well. How can I help you today?"
              - intent: chat
              - skills: []
          expect:
            calls:
              - step: chat
                exactly: 1

    - name: code-exploration
      description: Activate code-explorer skill for code questions
      flow:
        - name: code-flow
          event: manual
          fixture: local.minimal
          routing:
            max_loops: 0
          execution_context:
            conversation:
              transport: cli
              thread: { id: "test-2" }
              messages: [{ role: user, text: "How does authentication work?", timestamp: "2024-01-01T00:00:00Z" }]
              current: { role: user, text: "How does authentication work?", timestamp: "2024-01-01T00:00:00Z" }
              attributes: { source: cli }
          mocks:
            chat[]:
              - text: "Authentication is handled via JWT tokens."
              - intent: code_help
              - skills: [code-explorer]
          expect:
            calls:
              - step: chat
                exactly: 1

    - name: capabilities-skill
      description: Activate capabilities skill when asked what assistant can do
      flow:
        - name: capabilities-flow
          event: manual
          fixture: local.minimal
          routing:
            max_loops: 0
          execution_context:
            conversation:
              transport: cli
              thread: { id: "test-3" }
              messages: [{ role: user, text: "What can you help me with?", timestamp: "2024-01-01T00:00:00Z" }]
              current: { role: user, text: "What can you help me with?", timestamp: "2024-01-01T00:00:00Z" }
              attributes: { source: cli }
          mocks:
            chat[]:
              - text: "I can help with code exploration, engineering, and more!"
              - intent: chat
              - skills: [capabilities]
          expect:
            calls:
              - step: chat
                exactly: 1
