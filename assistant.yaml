# Visor Quickstart Assistant
# Run:  npx -y @probelabs/visor@latest run assistant.yaml --message "Hello"
# Test: npx -y @probelabs/visor@latest test assistant.yaml

version: "1.0"

# Imports the assistant workflow engine (intent classification, skill activation, tools)
imports:
  - https://raw.githubusercontent.com/probelabs/visor-ee/master/workflows/assistant.yaml

# Slack config (remove if CLI-only)
slack:
  version: "v1"
  mentions: all
  threads: required

# --- Main workflow ---
checks:
  chat:
    type: workflow
    workflow: assistant
    assume: ["true"]
    args:
      question: "{{ conversation.current.text }}"

      # System prompt — who is this assistant?
      system_prompt: |
        You are a Probe Labs assistant helping developers understand and build
        AI assistants with Visor. You can explore code, explain Visor concepts,
        and demonstrate how skills, intents, and tools work together.

      # Intents — broad request categories
      intents:
        - id: chat
          description: |
            General Q&A, follow-up questions, small talk, or simple requests.
            Includes capabilities questions and summaries.

        - id: code_help
          description: |
            Questions about code, implementation, architecture, or debugging.
            Use when the user needs to understand or explore code.

        - id: task
          description: |
            User wants to create, update, or execute something.
            Includes creating tickets, making code changes, or running tasks.

      # Skills — assistant capabilities that activate based on user intent
      skills:
        # Knowledge-only skill (inline knowledge, no tools)
        - id: capabilities
          description: user asks what this assistant can do or about its capabilities
          knowledge: |
            ## What I Can Do
            I'm a Probe Labs demo assistant showcasing Visor. I can:
            - **Explain Visor** — how skills, intents, tools, and knowledge work
            - **Explore code** — search this quickstart repo and the Visor engine
            - **Make changes** — create PRs and modify code via the engineer tool
            Ask me anything about building AI assistants with Visor!

        # Knowledge-from-file skill (uses {% readfile %} to load docs)
        - id: visor-guide
          description: |
            user asks how Visor works, how to build assistants, about skills,
            intents, tools, knowledge, readfile, YAML config, or deployment
          knowledge: |
            {% readfile "docs/visor-overview.md" %}

        # Workflow tool skill (code-talk for code exploration)
        - id: code-explorer
          description: needs codebase exploration, code search, or implementation details
          knowledge: |
            ## Code Exploration
            You can search and explore code across multiple repositories.
            Always provide specific file paths and line numbers in your answers.
          tools:
            code-explorer:
              workflow: code-talk
              inputs:
                projects:
                  - name: quickstart
                    path: .
                    description: This quickstart repo (assistant config, docs, examples)
                  - name: visor
                    repo: probelabs/visor
                    description: The Visor engine (runtime, CLI, workflows)
          # Bash commands this skill can run (read-only git operations)
          allowed_commands:
            - "git:log:*"
            - "git:show:*"
            - "git:diff:*"

        # Skill with dependency (requires code-explorer)
        - id: engineer
          description: user wants code changes made, a PR created, or a feature implemented
          requires: [code-explorer]
          knowledge: |
            ## Engineering
            You can make code changes using the engineer tool.
            Always explore the codebase first to understand context,
            then use the engineer tool to make changes.
          tools:
            engineer:
              workflow: engineer
              inputs: {}
          # Bash commands: allow git operations but block destructive ones
          allowed_commands:
            - "git:*"
            - "npm:*"
          disallowed_commands:
            - "git:push:--force"
            - "git:reset:--hard"

        # Commented-out MCP command tool example
        # - id: jira
        #   description: user mentions Jira, ticket IDs like PROJ-123, or needs ticket info
        #   knowledge: |
        #     ## Jira Tools
        #     - jira_get_issue: Get ticket details by key
        #     - jira_search: Search with JQL queries
        #     - jira_create_issue: Create new tickets
        #   tools:
        #     jira:
        #       command: uvx
        #       args: ["mcp-atlassian"]
        #       env:
        #         JIRA_URL: "${JIRA_URL}"
        #         JIRA_USERNAME: "${JIRA_USERNAME}"
        #         JIRA_API_TOKEN: "${JIRA_API_TOKEN}"
        #       allowedMethods:
        #         - jira_get_issue
        #         - jira_search
        #         - jira_create_issue

# --- Tests ---
# Run: npx -y @probelabs/visor@latest test assistant.yaml
tests:
  defaults:
    strict: true
    ai_provider: mock

  cases:
    - name: basic-chat
      description: Route general chat correctly
      flow:
        - name: chat-flow
          event: manual
          fixture: local.minimal
          routing:
            max_loops: 0
          execution_context:
            conversation:
              transport: cli
              thread: { id: "test-1" }
              messages: [{ role: user, text: "Hello, how are you?", timestamp: "2024-01-01T00:00:00Z" }]
              current: { role: user, text: "Hello, how are you?", timestamp: "2024-01-01T00:00:00Z" }
              attributes: { source: cli }
          mocks:
            chat[]:
              - text: "Hello! I'm doing well. How can I help you today?"
              - intent: chat
              - skills: []
          expect:
            calls:
              - step: chat
                exactly: 1

    - name: visor-guide
      description: Activate visor-guide skill for Visor questions
      flow:
        - name: guide-flow
          event: manual
          fixture: local.minimal
          routing:
            max_loops: 0
          execution_context:
            conversation:
              transport: cli
              thread: { id: "test-2" }
              messages: [{ role: user, text: "How do skills work in Visor?", timestamp: "2024-01-01T00:00:00Z" }]
              current: { role: user, text: "How do skills work in Visor?", timestamp: "2024-01-01T00:00:00Z" }
              attributes: { source: cli }
          mocks:
            chat[]:
              - text: "Skills are self-contained capabilities that activate based on user intent."
              - intent: chat
              - skills: [visor-guide]
          expect:
            calls:
              - step: chat
                exactly: 1

    - name: code-exploration
      description: Activate code-explorer skill for code questions
      flow:
        - name: code-flow
          event: manual
          fixture: local.minimal
          routing:
            max_loops: 0
          execution_context:
            conversation:
              transport: cli
              thread: { id: "test-3" }
              messages: [{ role: user, text: "Show me what's in assistant.yaml", timestamp: "2024-01-01T00:00:00Z" }]
              current: { role: user, text: "Show me what's in assistant.yaml", timestamp: "2024-01-01T00:00:00Z" }
              attributes: { source: cli }
          mocks:
            chat[]:
              - text: "The assistant.yaml file defines the quickstart assistant configuration."
              - intent: code_help
              - skills: [code-explorer]
          expect:
            calls:
              - step: chat
                exactly: 1

    - name: capabilities
      description: Activate capabilities skill when asked what assistant can do
      flow:
        - name: capabilities-flow
          event: manual
          fixture: local.minimal
          routing:
            max_loops: 0
          execution_context:
            conversation:
              transport: cli
              thread: { id: "test-4" }
              messages: [{ role: user, text: "What can you help me with?", timestamp: "2024-01-01T00:00:00Z" }]
              current: { role: user, text: "What can you help me with?", timestamp: "2024-01-01T00:00:00Z" }
              attributes: { source: cli }
          mocks:
            chat[]:
              - text: "I can help with code exploration, Visor guidance, and engineering!"
              - intent: chat
              - skills: [capabilities]
          expect:
            calls:
              - step: chat
                exactly: 1
