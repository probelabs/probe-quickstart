# =============================================================================
# engineer: Code Modification Workflow
# =============================================================================
#
# Makes code changes, creates PRs, and implements features using Claude Code.
# This workflow is designed to be called from an agent that has already
# explored the codebase using code-helper.
#
# Usage:
#   As a workflow step:
#     type: workflow
#     workflow: engineer
#     args:
#       task: "Add a health check endpoint"
#       context: "The API handlers are in src/api/handlers.go"
#       projects:
#         - "/tmp/visor/your-project"
#
#   As an MCP tool (via ai_mcp_servers):
#     servers['engineer'] = {
#       workflow: 'engineer',
#       inputs: {}  # AI provides task, context, and projects
#     };
#
# Best Practice:
#   1. First use code-helper to explore the codebase
#   2. Get file paths and patterns from code-helper output
#   3. Then call engineer with specific task, context, and project paths
#
# =============================================================================

version: "1.0"

id: engineer
name: Code Engineer

inputs:
  - name: task
    required: true
    description: The task to implement
    schema:
      type: string

  - name: context
    required: false
    description: Context from prior code exploration (e.g., from code-helper)
    default: ""
    schema:
      type: string

  - name: projects
    required: false
    description: List of project directory paths to add to Claude Code workspace
    default: []
    schema:
      type: array
      items:
        type: string

  - name: architecture
    required: false
    description: Architecture document with project topology and guidelines
    default: |
      # Project Architecture

      Replace this with your architecture documentation.
      You can use {% readfile "docs/architecture.md" %} to load from a file.
    schema:
      type: string

outputs:
  - name: result
    value_js: |
      const engineerStep = outputs?.['engineer-task'];
      if (typeof engineerStep === 'string') {
        return { text: engineerStep };
      }
      if (engineerStep && typeof engineerStep === 'object') {
        if (typeof engineerStep.stdout === 'string') return { text: engineerStep.stdout };
        if (typeof engineerStep.value === 'string') return { text: engineerStep.value };
        if (engineerStep.value?.text) return engineerStep.value;
        return engineerStep;
      }
      return null;

steps:
  # Build the prompt and command for Claude Code
  build-engineer-prompt:
    type: script
    criticality: internal
    schema:
      type: object
      properties:
        command:
          type: string
    assume:
      - "true"
    fanout: reduce
    content: |
      const task = inputs.task ?? '';
      const context = inputs.context ?? '';
      const architecture = inputs.architecture ?? '';
      const projects = Array.isArray(inputs.projects) ? inputs.projects : [];

      // Build prompt
      const promptLines = [
        '<task>',
        task,
        '</task>',
        ''
      ];

      // Add context if provided (from prior code exploration)
      if (context && context.trim()) {
        promptLines.push(
          '<context>',
          'The following context was gathered from prior code exploration:',
          '',
          context,
          '</context>',
          ''
        );
      }

      promptLines.push(
        '<architecture>',
        architecture,
        '</architecture>',
        '',
        '<instructions>',
        'You are a senior engineer. Your goal is to implement the task described above.',
        '',
        '## Process',
        '',
        '### Phase 1: Clarify Requirements',
        '',
        'Before writing ANY code, carefully review the task and context. Ask yourself:',
        '- Is the task description clear and unambiguous?',
        '- Are there multiple ways to interpret what is being asked?',
        '- Are there missing details that could lead to wrong implementation?',
        '',
        'If ANYTHING is unclear or ambiguous:',
        '- STOP and list your questions',
        '- Ask the user for clarification BEFORE proceeding',
        '',
        '### Phase 2: Plan the Implementation',
        '',
        'Once requirements are clear, create a detailed plan BEFORE coding:',
        '',
        '1. List ALL files that need to be modified or created',
        '2. Describe the specific changes for each file',
        '3. Identify dependencies between changes',
        '4. Consider edge cases and error handling',
        '',
        '### Phase 3: Implement',
        '',
        '1. Follow the implementation approach from your plan',
        '2. Make changes that follow existing code style and patterns',
        '3. Keep changes focused and minimal',
        '4. Make incremental changes and verify each step works',
        '',
        '### Phase 4: Verify',
        '',
        '- You MUST verify that the code builds successfully after your changes',
        '- Run the appropriate build command (e.g., go build, npm run build, make)',
        '',
        '### Phase 5: Deliver',
        '',
        'When done, provide a summary that includes:',
        '- What you changed and why',
        '- List of modified files',
        '- Build verification status',
        '- PR URL if you created one',
        '',
        'Create a PR using gh tool. If a PR for this branch already exists, update it.',
        '</instructions>'
      );
      const prompt = promptLines.join('\n');

      // Build the full command with properly escaped prompt
      // Use base64 encoding to safely pass the prompt through shell
      const promptBase64 = btoa(unescape(encodeURIComponent(prompt)));

      let cmd = 'echo "' + promptBase64 + '" | base64 -d | claude -p --dangerously-skip-permissions';

      // Add project directories if provided
      for (const dir of projects) {
        if (dir && typeof dir === 'string') {
          cmd += ' --add-dir "' + dir.replace(/"/g, '\\"') + '"';
        }
      }

      return { command: cmd };

  # Use Claude Code CLI to implement the task
  engineer-task:
    type: command
    criticality: policy
    depends_on: [build-engineer-prompt]
    assume:
      - "outputs['build-engineer-prompt'] != null"
    guarantee: "output != null"
    timeout: 1800000  # 30 minutes for Claude Code to complete
    exec: "{{ outputs['build-engineer-prompt'].command }}"
    transform_js: |
      if (typeof output === 'string') {
        return { text: output };
      }
      if (output?.text) return output;
      if (output?.stdout) return { text: output.stdout };
      if (typeof output?.value === 'string') return { text: output.value };
      if (output?.value?.text) return output.value;
      return { text: String(output ?? '') };

# =============================================================================
# Tests
# =============================================================================
tests:
  defaults:
    strict: true
    ai_provider: mock

  cases:
    - name: basic-engineering-task
      event: manual
      fixture: local.minimal
      workflow_input:
        task: "Add a new endpoint to check health status"
        context: "The API handlers are in src/api/handlers.go. Health endpoints typically return JSON."
      mocks:
        engineer-task: "Added /health endpoint. Files changed: src/api/handlers.go"
      expect:
        calls:
          - step: build-engineer-prompt
            exactly: 1
          - step: engineer-task
            exactly: 1
        workflow_output:
          - path: result.text
            contains: "Added /health endpoint"

    - name: task-with-projects
      event: manual
      fixture: local.minimal
      workflow_input:
        task: "Add rate limiting to the API"
        context: "Rate limiting middleware goes in src/middleware/"
        projects:
          - "/tmp/visor/my-project"
      mocks:
        engineer-task: "Added rate limiting middleware. PR created."
      expect:
        calls:
          - step: build-engineer-prompt
            exactly: 1
          - step: engineer-task
            exactly: 1
