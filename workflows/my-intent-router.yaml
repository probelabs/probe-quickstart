# =============================================================================
# my-intent-router: Custom Intent Router
# =============================================================================
#
# This workflow wraps the intent-router from visor-ee with your custom
# intent and tag definitions.
#
# Customize by:
#   1. Adding/modifying intents (chat, code_help, task, etc.)
#   2. Adding/modifying tags (codebase, jira, engineer, etc.)
#   3. Adding routing_instructions for special cases
#
# Usage:
#   type: workflow
#   config: workflows/my-intent-router.yaml
#   workflow_inputs:
#     question: "How does auth work?"
#
# =============================================================================

id: my-intent-router
name: Custom Intent Router
description: Classify user intent for assistant flows
version: "1.0.0"

# Import the base intent-router from visor-ee
# This provides the core classification logic
#
# Want advanced features? The visor-ee intent-router includes:
#   - Explicit markers (#tag, %intent) for user control
#   - Confidence scoring
#   - Multi-intent detection
# See: https://github.com/probelabs/visor-ee
imports:
  - https://raw.githubusercontent.com/probelabs/visor-ee/master/workflows/intent-router.yaml

inputs:
  - name: question
    required: true
    schema:
      type: string

outputs:
  - name: intent
    value_js: |
      return outputs?.classify?.intent ?? null;

  - name: topic
    value_js: |
      return outputs?.classify?.topic ?? null;

  - name: tags
    value_js: |
      return outputs?.classify?.tags ?? [];

steps:
  classify:
    type: workflow
    workflow: intent-router
    criticality: internal
    args:
      question: "{{ inputs.question }}"

      # =====================================================================
      # Intent Definitions
      # =====================================================================
      # Define the high-level intents your assistant can handle.
      # Each intent routes to a different handler or modifies behavior.
      #
      # Tips:
      #   - Keep descriptions clear and mutually exclusive
      #   - Include example phrases to help the AI classify correctly
      #   - Order doesn't matter; the AI picks the best match
      # =====================================================================
      intents:
        - id: chat
          description: |
            General Q&A, follow-up questions, small talk, or simple requests.
            Also use for:
              - "what can you do?" / capabilities questions
              - "summarize this" / summary requests
              - Simple questions that don't need tools
            These are handled via tags, not separate intents.

        - id: code_help
          description: |
            User asks about code, implementation, documentation, or debugging.
            Includes:
              - Code/implementation questions ("how does X work?")
              - Documentation questions ("where is X documented?")
              - Technical architecture questions
              - Debugging and investigation requests
            Use the 'engineer' tag when user wants actual code changes made.

        - id: task
          description: |
            User wants to create, update, or modify something.
            Includes:
              - Creating tickets, issues, or PRs
              - Updating records or documentation
              - Executing actions that change state

      # =====================================================================
      # Tag Definitions
      # =====================================================================
      # Tags modify behavior by enabling tools or injecting knowledge.
      # Multiple tags can be applied to a single request.
      #
      # Tips:
      #   - Tags are additive; use them to layer capabilities
      #   - Reference tags in ai_mcp_servers_js to load tools
      #   - Reference tags in prompts to inject knowledge
      # =====================================================================
      tags:
        # Capability tags
        - id: capabilities
          description: User asks what this assistant can do, help options, or available features

        - id: codebase
          description: Request needs codebase exploration or implementation details

        - id: engineer
          description: |
            User explicitly wants code changes made, a PR created, feature implemented, or bug fixed.
            Includes: "create a PR", "implement...", "fix the bug", "add a new endpoint"

        # Integration tags - uncomment as needed
        # - id: jira
        #   description: Request references Jira tickets or needs to read/search Jira data

        # - id: confluence
        #   description: Request references Confluence pages or needs Confluence data

        # - id: zendesk
        #   description: Request references Zendesk tickets or needs Zendesk data

        # - id: github
        #   description: Request involves GitHub (PRs, issues, Actions, etc.)

        # Scheduling
        - id: scheduler
          description: |
            User wants to schedule, list, cancel, or manage scheduled workflow executions.
            Includes: "remind me", "schedule a check", "run this every day at 9am"

      # =====================================================================
      # Routing Instructions (optional)
      # =====================================================================
      # Add custom routing rules for edge cases or domain-specific logic.
      # These instructions are appended to the classifier prompt.
      # =====================================================================
      routing_instructions: |
        When selecting tags, consider the full conversation context.
        The current message may be a brief follow-up that only makes sense
        when you review what was discussed earlier.

        For example:
        - A message saying "yes, do it" should inherit relevant tags from
          the prior discussion
        - A short reply like "go ahead" after discussing code changes should
          get the 'engineer' tag

# =============================================================================
# Tests
# =============================================================================
tests:
  defaults:
    strict: true
    ai_provider: mock

  cases:
    - name: classify-code-question
      event: manual
      fixture: local.minimal
      workflow_input:
        question: "How does authentication work in the backend?"
      mocks:
        classify:
          intent: code_help
          topic: "How does authentication work in the backend?"
          tags: ["codebase"]
      expect:
        calls:
          - step: classify
            exactly: 1
        workflow_output:
          - path: intent
            equals: "code_help"
          - path: tags
            contains: "codebase"

    - name: classify-capabilities
      event: manual
      fixture: local.minimal
      workflow_input:
        question: "What can you help me with?"
      mocks:
        classify:
          intent: chat
          topic: "What can you help me with?"
          tags: ["capabilities"]
      expect:
        calls:
          - step: classify
            exactly: 1
        workflow_output:
          - path: intent
            equals: "chat"
          - path: tags
            contains: "capabilities"

    - name: classify-engineer-request
      event: manual
      fixture: local.minimal
      workflow_input:
        question: "Create a PR to add a new health check endpoint"
      mocks:
        classify:
          intent: code_help
          topic: "Create a PR to add a health check endpoint"
          tags: ["codebase", "engineer"]
      expect:
        calls:
          - step: classify
            exactly: 1
        workflow_output:
          - path: intent
            equals: "code_help"
          - path: tags
            contains: "engineer"
