# =============================================================================
# Slack Integration Example
# =============================================================================
#
# A Visor assistant configured for Slack with thread support.
#
# Usage:
#   npx -y @probelabs/visor@latest run examples/slack-integration.yaml --slack
#
# Required Environment Variables:
#   - SLACK_BOT_TOKEN: xoxb-...
#   - SLACK_APP_TOKEN: xapp-...
#   - ANTHROPIC_API_KEY: sk-ant-...
#
# Slack App Setup:
#   1. Create a Slack app at https://api.slack.com/apps
#   2. Enable Socket Mode and get an app-level token (xapp-...)
#   3. Add bot token scopes: chat:write, app_mentions:read, channels:history
#   4. Install the app to your workspace
#   5. Set the environment variables
#
# =============================================================================

version: "1.0"

# Slack configuration
slack:
  version: "v1"
  # mentions: all - respond to all @mentions
  # mentions: direct - only respond to direct @mentions (not in threads)
  mentions: all
  # threads: required - only work within threads
  # threads: optional - work in both threads and channels
  threads: required
  # Show raw AI output in addition to formatted response
  show_raw_output: false
  # Allow processing bot messages (for multi-bot workflows)
  allow_bot_messages: false

# Import workflows
imports:
  - ../workflows/my-intent-router.yaml

checks:
  # -------------------------------------------------------------------------
  # Wait for Slack message
  # -------------------------------------------------------------------------
  ask:
    type: human-input
    group: assistant
    criticality: internal
    prompt: |
      Hi! I'm your Slack assistant. How can I help?

  # -------------------------------------------------------------------------
  # Log incoming request (optional - for debugging)
  # -------------------------------------------------------------------------
  log-request:
    type: log
    group: assistant
    criticality: internal
    depends_on: [ask]
    assume:
      - "outputs['ask'] != null"
    level: info
    include_pr_context: false
    include_dependencies: false
    include_metadata: false
    message: |
      Request from user: {{ conversation.attributes.user | default: 'unknown' }}
      Channel: {{ conversation.attributes.channel | default: 'unknown' }}
      Thread: {{ conversation.thread.url | default: 'unknown' }}
      Message: {{ outputs['ask'].text | truncate: 200 }}

  # -------------------------------------------------------------------------
  # Route intent
  # -------------------------------------------------------------------------
  route-intent:
    type: workflow
    group: assistant
    depends_on: [ask]
    criticality: internal
    assume:
      - "outputs['ask'] != null"
    guarantee: "output?.intent != null"
    config: ../workflows/my-intent-router.yaml
    workflow_inputs:
      question: "{{ conversation.current.text | default: outputs['ask'].text }}"
    on_success:
      transitions:
        - when: "output.intent === 'chat'"
          to: chat-answer
        - when: "output.intent === 'code_help'"
          to: chat-answer
        - when: "output.intent === 'task'"
          to: chat-answer

  # -------------------------------------------------------------------------
  # Generate response
  # -------------------------------------------------------------------------
  chat-answer:
    type: ai
    group: assistant
    depends_on: [route-intent, ask]
    criticality: policy
    if: "outputs['route-intent']?.intent != null"
    guarantee: "(output?.text ?? '').length > 0"
    schema:
      type: object
      properties:
        text:
          type: string
      required: [text]
    ai:
      max_iterations: 20
      skip_code_context: true
    prompt: |
      You are a helpful Slack assistant.

      <history>
      {% assign history = '' | chat_history: 'ask', 'chat-answer' %}
      {% for m in history %}
      {{ m.role | capitalize }}: {{ m.text }}
      {% endfor %}
      </history>

      ## Current Request
      User: {{ outputs['ask'].text }}

      ## Intent: {{ outputs['route-intent'].intent }}
      ## Tags: {{ outputs['route-intent'].tags | join: ', ' }}

      {% if outputs['route-intent'].tags contains 'capabilities' %}
      ## Capabilities
      I can help with:
      - General Q&A and conversations
      - Code exploration and questions
      - Task execution
      {% endif %}

      ## Guidelines
      - Be helpful and concise
      - Use Slack formatting when appropriate (bold, lists, code blocks)
      - Keep responses focused

    on_success:
      goto: ask
    on_fail:
      goto: error-handler

  # -------------------------------------------------------------------------
  # Error handler
  # -------------------------------------------------------------------------
  error-handler:
    type: log
    group: assistant
    criticality: info
    depends_on: []
    if: "outputs['chat-answer']?.text == null"
    level: info
    include_pr_context: false
    include_dependencies: false
    include_metadata: false
    message: |
      Sorry, I encountered an issue processing your request.
      Please try rephrasing or providing more details.
    on_success:
      goto: ask

tests:
  defaults:
    strict: true
    ai_provider: mock

  cases:
    - name: slack-greeting
      flow:
        - name: greeting-flow
          event: manual
          fixture: local.minimal
          routing:
            max_loops: 0
          mocks:
            ask[]:
              - text: "Hello!"
            route-intent[]:
              - { intent: chat, topic: "Hello!", tags: [] }
            chat-answer[]:
              - text: "Hello! How can I help you today?"
          expect:
            calls:
              - step: ask
                exactly: 1
              - step: route-intent
                exactly: 1
              - step: chat-answer
                exactly: 1
